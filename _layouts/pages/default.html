<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ site.title }}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hanken+Grotesk:ital,wght@0,100..900;1,100..900&display=swap');
  </style>
  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('viewMode');
    if (savedTheme === 'research') {
      document.documentElement.classList.add('research-theme');
    }
  </script>
  <style>
    /* Mobile Navigation Styles */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 0.75rem 1rem;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .mobile-nav {
        display: block;
      }
      .desktop-top-nav {
        display: none;
      }
      .main-content-row {
        flex-direction: column;
      }
      body {
        padding-bottom: 4rem; /* Add space for mobile nav */
      }
    }

    @media (min-width: 769px) {
      body {
        margin: 0;
        padding: 2rem;
        height: 100vh;
        overflow: hidden;
      }
      .page-center-wrap {
        display: flex;
        justify-content: center;
        height: 100vh;
        overflow: hidden;
      }
      .page-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-width: 1600px;
        width: 100%;
        height: calc(100vh - 4rem);
        overflow: hidden;
      }
      .top-nav-container {
        flex: 0 0 auto;
        background: white;
        border-radius: 1rem;
        display: flex;
        gap: 1rem;
      }
      #main-container {
        padding: 0 !important;
      }
      .left-nav {
        flex: 0 0 600px;
        display: flex;
        align-items: center;
      }
      .right-nav {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }
      .right-nav .works-nav-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: flex-end;
      }
      .panels-container {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        flex: 1;
        overflow: hidden;
      }
      .main-panel {
        flex: 0 0 600px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-width: 0;
        height: 100%;
        overflow: hidden;
      }
      .works-panel {
        flex: 1;
        background: white;
        border-radius: 0;
        padding: 0;
        overflow-y: auto;
        display: block;
        transition: all 0.3s ease;
        opacity: 1;
        transform: translateX(0);
        min-width: 0;
        height: 100%;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* Internet Explorer 10+ */
      }
      
      .works-panel::-webkit-scrollbar {
        display: none; /* WebKit */
      }
      
      .works-panel.scrolling {
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: #ddd transparent; /* Firefox */
      }
      
      .works-panel.scrolling::-webkit-scrollbar {
        display: block;
        width: 4px;
      }
      
      .works-panel.scrolling::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .works-panel.scrolling::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 2px;
      }
      
      .works-panel.scrolling::-webkit-scrollbar-thumb:hover {
        background: #ccc;
      }
      .works-panel.hide {
        display: none;
        opacity: 0;
        transform: translateX(20px);
      }
      
      /* Works panel specific styles */
      
      .right-nav .works-nav-button {
        padding: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        color: #4b5563;
        background: #f3f4f6;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      
      .right-nav .works-nav-button i {
        font-size: 0.7rem;
      }
      
      /* Filter type specific colors */
      .right-nav .works-nav-button[data-filter="all"] {
        background: #f3f4f6;
        color: #6b7280;
      }
      
      .right-nav .works-nav-button[data-filter="all"]:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .right-nav .works-nav-button[data-filter="all"].active {
        background: #6b7280;
        color: white;
      }
      
      .right-nav .works-nav-button[data-filter="project"] {
        background: #fef3c7;
        color: #d97706;
      }
      
      .right-nav .works-nav-button[data-filter="project"]:hover {
        background: #fde68a;
        color: #b45309;
      }
      
      .right-nav .works-nav-button[data-filter="project"].active {
        background: #d97706;
        color: white;
      }
      
      .right-nav .works-nav-button[data-filter="pub"] {
        background: #dbeafe;
        color: #2563eb;
      }
      
      .right-nav .works-nav-button[data-filter="pub"]:hover {
        background: #bfdbfe;
        color: #1d4ed8;
      }
      
      .right-nav .works-nav-button[data-filter="pub"].active {
        background: #2563eb;
        color: white;
      }
      
      .right-nav .works-nav-button[data-filter="news"] {
        background: #fce7f3;
        color: #be185d;
      }
      
      .right-nav .works-nav-button[data-filter="news"]:hover {
        background: #fbcfe8;
        color: #9d174d;
      }
      
      .right-nav .works-nav-button[data-filter="news"].active {
        background: #be185d;
        color: white;
      }
      
      /* Mobile filter button styling */
      .mobile-works-filter-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        background: #f3f4f6;
        color: #4b5563;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
      }
      
      .mobile-works-filter-btn i {
        font-size: 0.8rem;
      }
      
      .mobile-works-filter-btn:hover {
        background: #e5e7eb;
        color: #1f2937;
      }
      
      .mobile-works-filter-btn.active {
        background: #2563eb;
        color: white;
      }
      
      /* Mobile filter type specific colors */
      .mobile-works-filter-btn[data-filter="all"] {
        background: #f3f4f6;
        color: #6b7280;
      }
      
      .mobile-works-filter-btn[data-filter="all"]:hover {
        background: #e5e7eb;
        color: #374151;
      }
      
      .mobile-works-filter-btn[data-filter="all"].active {
        background: #6b7280;
        color: white;
      }
      
      .mobile-works-filter-btn[data-filter="project"] {
        background: #fef3c7;
        color: #d97706;
      }
      
      .mobile-works-filter-btn[data-filter="project"]:hover {
        background: #fde68a;
        color: #b45309;
      }
      
      .mobile-works-filter-btn[data-filter="project"].active {
        background: #d97706;
        color: white;
      }
      
      .mobile-works-filter-btn[data-filter="pub"] {
        background: #dbeafe;
        color: #2563eb;
      }
      
      .mobile-works-filter-btn[data-filter="pub"]:hover {
        background: #bfdbfe;
        color: #1d4ed8;
      }
      
      .mobile-works-filter-btn[data-filter="pub"].active {
        background: #2563eb;
        color: white;
      }
      
      .mobile-works-filter-btn[data-filter="news"] {
        background: #fce7f3;
        color: #be185d;
      }
      
      .mobile-works-filter-btn[data-filter="news"]:hover {
        background: #fbcfe8;
        color: #9d174d;
      }
      
      .mobile-works-filter-btn[data-filter="news"].active {
        background: #be185d;
        color: white;
      }
      
      
      
      .works-panel .pubs-list {
        column-count: 3;
        column-gap: 16px;
        width: 100%;
      }
      
      .works-panel .pub-item {
        display: inline-block;
        width: 100%;
        margin-bottom: 16px;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        box-sizing: border-box;
        break-inside: avoid;
      }
      
      .works-panel .pub-image {
        width: 100%;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #f8f9fa;
        border-bottom: none;
        border-radius: 4px 4px 0 0;
      }
      
      .works-panel .pub-image img,
      .works-panel .placeholder-image {
        width: 100%;
        height: auto;
        object-fit: contain;
        display: block;
      }
      
      .works-panel .pub-content {
        padding: 12px 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background-color: #f8f9fa;
        border-radius: 0 0 4px 4px;
      }
      
      .works-panel .pub-title {
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
        text-decoration: none !important;
      }
      
      .works-panel .pub-item[data-type="news"] .pub-title {
        font-weight: 400;
      }
      
      .works-panel .pub-date {
        font-size: 11px;
        color: #999;
        line-height: 1.2;
        margin-bottom: 4px;
        text-decoration: none !important;
      }
      
      .works-panel .pub-meta {
        font-size: 12px;
        color: #666;
        line-height: 1.2;
        text-decoration: none !important;
      }
      
      .works-panel .placeholder-image {
        width: 100%;
        height: 120px;
        background: #f8f8f8;
        border-radius: 16px;
        display: block;
      }
      .main-content-row {
        display: flex;
        flex: 1;
        height: 100%;
        overflow: hidden;
      }
      .container {
        width: 100%;
        max-width: 100%;
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
        overflow: hidden;
      }
      .content {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        scroll-behavior: smooth;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* Internet Explorer 10+ */
      }
      
      .content::-webkit-scrollbar {
        display: none; /* WebKit */
      }
      
      .content.scrolling {
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: #ddd transparent; /* Firefox */
      }
      
      .content.scrolling::-webkit-scrollbar {
        display: block;
        width: 4px;
      }
      
      .content.scrolling::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .content.scrolling::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 2px;
      }
      
      .content.scrolling::-webkit-scrollbar-thumb:hover {
        background: #ccc;
      }
    }
  </style>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
</head>
<body style="min-height:100vh;">
  <div class="page-center-wrap" style="display:flex;justify-content:center;height:100vh;width:100vw;overflow:hidden;">
    <div class="page-container">
      <!-- Top Navigation -->
      <div class="top-nav-container">
        <div class="left-nav">
          {% include components/navigation.html %}
        </div>
        <div class="right-nav">
          <div class="works-nav-buttons">
            <button class="works-nav-button active" data-filter="all"><i class="fas fa-th"></i> All</button>
            <button class="works-nav-button" data-filter="project"><i class="fas fa-code"></i> Projects</button>
            <button class="works-nav-button" data-filter="pub"><i class="fas fa-file-alt"></i> Publications</button>
            <button class="works-nav-button" data-filter="news"><i class="fas fa-newspaper"></i> News</button>
          </div>
        </div>
      </div>
      
      <!-- Panels Container -->
      <div class="panels-container">
        <div class="main-panel">
          <div class="main-content-row">
            <div class="container" id="main-container">
              <main class="content content-{{ page.id | default: page.title | replace: ' ', '-' | slice: 0, 5 }}" id="main-content">
                {{ content }}
              </main>
            </div>
          </div>
        </div>
        
        {% include components/minimap.html %}
        
        <!-- Works Panel (Desktop Only) -->
        <div class="works-panel" id="works-panel">
        <div class="pubs-list" style="margin:0 auto;">
          {% comment %} Render news first (most recent) {% endcomment %}
          {% assign sorted_news = site.data.news.news_items | sort: 'date' | reverse %}
          {% for news_item in sorted_news limit: 10 %}
            <div class="pub-item" data-type="news" data-date="{{ news_item.date }}">
              {% if news_item.image %}
              <a href="{{ news_item.link | default: '#' }}" class="pub-image-link">
                <div class="pub-image">
                  <img src="{{ '/assets/images/projects/' | append: news_item.image | relative_url }}" alt="{{ news_item.title }}">
                </div>
              </a>
              {% endif %}
              <div class="pub-content">
                <div class="pub-header">
                  <div class="pub-date">{{ news_item.date | date: '%b %Y' }}</div>
                  <div class="pub-title">{{ news_item.title }}</div>
                </div>
              </div>
            </div>
          {% endfor %}
          
          {% comment %} Then render publications {% endcomment %}
          {% assign sorted_publications = site.data.pubs | sort: 'year' | reverse %}
          {% for pub in sorted_publications %}
            {% assign author_list = pub.authors | split: ',' %}
            {% assign first_author = author_list[0] | strip %}
            {% if first_author contains 'Emran Poh' %}
            <div class="pub-item" data-type="pub" data-date="{{ pub.year }}-12-31">
              <a href="{{ pub.url | relative_url }}" class="pub-image-link">
                <div class="pub-image">
                  {% if pub.image %}
                  <img src="{{ '/assets/images/projects/' | append: pub.image | relative_url }}" alt="{{ pub.title }}">
                  {% else %}
                  <div class="placeholder-image"></div>
                  {% endif %}
                </div>
              </a>
              <a href="{{ pub.url | relative_url }}" class="pub-content">
                <div class="pub-header">
                  <div class="pub-meta">
                    {{ pub.venue_short }} {{ pub.year }}
                  </div>
                </div>
              </a>
            </div>
            {% endif %}
          {% endfor %}
          
          {% comment %} Then render projects {% endcomment %}
          {% assign sorted_projects = site.data.projects | sort: 'year' | reverse %}
          {% for project in sorted_projects %}
            <div class="pub-item" data-type="project" data-date="{{ project.year }}-12-31">
              <a href="{{ project.url | relative_url }}" class="pub-image-link">
                <div class="pub-image">
                  {% if project.image %}
                  <img src="{{ '/assets/images/projects/' | append: project.image | relative_url }}" alt="{{ project.title }}">
                  {% else %}
                  <div class="placeholder-image"></div>
                  {% endif %}
                </div>
              </a>
              <a href="{{ project.url | relative_url }}" class="pub-content">
                <div class="pub-header">
                  <div class="pub-title">{{ project.title }}</div>
                  {% if project.subtitle %}
                  <div class="pub-meta">{{ project.subtitle }}</div>
                  {% endif %}
                  {% if project.role %}
                  <div class="pub-meta">{{ project.role }}</div>
                  {% endif %}
                  {% if project.location %}
                  <div class="pub-meta">{{ project.location }}</div>
                  {% endif %}
                </div>
              </a>
            </div>
          {% endfor %}
          
          {% comment %} Finally render presentations {% endcomment %}
          {% for pres in site.data.others.presentations %}
            <div class="pub-item" data-type="presentation" data-date="{{ pres.date }}">
              <a href="{{ pres.link | default: '#' }}" class="pub-image-link">
                <div class="pub-image">
                  {% if pres.image %}
                    <img src="{{ '/assets/images/projects/' | append: pres.image | relative_url }}" alt="{{ pres.title }}">
                  {% else %}
                    <div class="placeholder-image"></div>
                  {% endif %}
                </div>
              </a>
              <div class="pub-content">
                <div class="pub-header">
                  <div class="pub-title">{{ pres.title }}</div>
                  <div class="pub-meta">{{ pres.event }}{% if pres.date %}, {{ pres.date | date: '%b %Y' }}{% endif %}</div>
                  <div class="pub-meta">{{ pres.description }}</div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mobile Navigation -->
  <div class="mobile-nav">
    {% include components/navigation.html %}
  </div>

  <!-- Mobile Works Panel -->
  <div class="mobile-works-overlay" id="mobile-works-overlay"></div>
  <div class="mobile-works-panel" id="mobile-works-panel">
    <div class="mobile-works-header">
      <h2 class="mobile-works-title">Works</h2>
    </div>
    
    <div class="mobile-works-filters">
      <button class="mobile-works-filter-btn active" data-filter="all"><i class="fas fa-th"></i> All</button>
      <button class="mobile-works-filter-btn" data-filter="project"><i class="fas fa-code"></i> Projects</button>
      <button class="mobile-works-filter-btn" data-filter="pub"><i class="fas fa-file-alt"></i> Publications</button>
      <button class="mobile-works-filter-btn" data-filter="news"><i class="fas fa-newspaper"></i> News</button>
    </div>
    
    <div class="mobile-works-content" id="mobile-works-content">
      {% comment %} Create a combined list and sort by date {% endcomment %}
      {% assign all_items = '' | split: '' %}
      
      {% comment %} Add news items {% endcomment %}
      {% for news_item in site.data.news.news_items limit: 10 %}
        {% assign item = news_item %}
        {% assign item = item | merge: hash: 'item_type', 'news' %}
        {% assign item = item | merge: hash: 'sort_date', news_item.date %}
        {% assign all_items = all_items | push: item %}
      {% endfor %}
      
      {% comment %} Add publications {% endcomment %}
      {% for pub in site.data.pubs %}
        {% assign author_list = pub.authors | split: ',' %}
        {% assign first_author = author_list[0] | strip %}
        {% if first_author contains 'Emran Poh' %}
          {% assign item = pub %}
          {% assign item = item | merge: hash: 'item_type', 'pub' %}
          {% assign item = item | merge: hash: 'sort_date', pub.year | append: '-12-31' %}
          {% assign all_items = all_items | push: item %}
        {% endif %}
      {% endfor %}
      
      {% comment %} Add projects {% endcomment %}
      {% for project in site.data.projects %}
        {% assign item = project %}
        {% assign item = item | merge: hash: 'item_type', 'project' %}
        {% assign item = item | merge: hash: 'sort_date', project.year | append: '-12-31' %}
        {% assign all_items = all_items | push: item %}
      {% endfor %}
      
      {% comment %} Add presentations {% endcomment %}
      {% for pres in site.data.others.presentations %}
        {% assign item = pres %}
        {% assign item = item | merge: hash: 'item_type', 'presentation' %}
        {% assign item = item | merge: hash: 'sort_date', pres.date %}
        {% assign all_items = all_items | push: item %}
      {% endfor %}
      
      {% comment %} Sort all items by date (newest first) {% endcomment %}
      {% assign sorted_items = all_items | sort: 'sort_date' | reverse %}
      
      {% comment %} Render all items in chronological order {% endcomment %}
      {% for item in sorted_items %}
        {% if item.item_type == 'news' %}
          <div class="mobile-works-item" data-type="news">
            <a href="{{ item.link | default: '#' }}" class="mobile-works-item-link">
              {% if item.image %}
              <div class="mobile-works-item-image">
                <img src="{{ '/assets/images/projects/' | append: item.image | relative_url }}" alt="{{ item.title }}">
              </div>
              {% endif %}
              <div class="mobile-works-item-content">
                <div class="mobile-works-item-date">{{ item.date | date: '%b %Y' }}</div>
                <h3 class="mobile-works-item-title">{{ item.title }}</h3>
              </div>
            </a>
          </div>
        {% elsif item.item_type == 'pub' %}
          <div class="mobile-works-item" data-type="pub">
            <a href="{{ item.url | relative_url }}" class="mobile-works-item-link">
              <div class="mobile-works-item-image">
                {% if item.images %}
                <div class="pub-image-gallery">
                  {% for image in item.images limit:4 %}
                  <img src="{{ '/assets/images/projects/' | append: image | relative_url }}" alt="{{ item.title }}">
                  {% endfor %}
                </div>
                {% elsif item.image %}
                  <img src="{{ '/assets/images/projects/' | append: item.image | relative_url }}" alt="{{ item.title }}">
                {% else %}
                  <div class="placeholder-image"></div>
                {% endif %}
              </div>
              <div class="mobile-works-item-content">
                <h3 class="mobile-works-item-title">{{ item.title }}</h3>
                <p class="mobile-works-item-meta">{{ item.venue }} • {{ item.year }}</p>
              </div>
            </a>
          </div>
        {% elsif item.item_type == 'project' %}
          <div class="mobile-works-item" data-type="project">
            <a href="{{ item.url | relative_url }}" class="mobile-works-item-link">
              <div class="mobile-works-item-image">
                {% if item.image %}
                  <img src="{{ '/assets/images/projects/' | append: item.image | relative_url }}" alt="{{ item.title }}">
                {% else %}
                  <div class="placeholder-image"></div>
                {% endif %}
              </div>
              <div class="mobile-works-item-content">
                <h3 class="mobile-works-item-title">{{ item.title }}</h3>
                <p class="mobile-works-item-meta">{{ item.year }} • {{ item.type }}</p>
              </div>
            </a>
          </div>
        {% elsif item.item_type == 'presentation' %}
          <div class="mobile-works-item" data-type="presentation">
            <a href="{{ item.link | default: '#' }}" class="mobile-works-item-link">
              {% if item.image %}
              <div class="mobile-works-item-image">
                <img src="{{ '/assets/images/projects/' | append: item.image | relative_url }}" alt="{{ item.title }}">
              </div>
              {% endif %}
              <div class="mobile-works-item-content">
                <h3 class="mobile-works-item-title">{{ item.title }}</h3>
                <p class="mobile-works-item-meta">{{ item.event }}{% if item.date %}, {{ item.date | date: '%b %Y' }}{% endif %}</p>
              </div>
            </a>
          </div>
        {% endif %}
      {% endfor %}
    </div>
    
    <!-- Mobile Navigation at bottom of works panel -->
    <div class="mobile-works-nav">
      {% include components/navigation.html %}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const worksPanel = document.getElementById('works-panel');
      const worksLinks = document.querySelectorAll('a[href*="/works"]');
      const homeLinks = document.querySelectorAll('a[href="/"]');
      let isWorksPanelOpen = true; // Start with panel open on home page

      // Check if we're on mobile
      function isMobile() {
        return window.innerWidth <= 768;
      }

      // Check if we're on the home page
      function isHomePage() {
        return window.location.pathname === '/' || window.location.pathname === '/index.html';
      }

      // Function to show works panel
      function showWorksPanel() {
        if (!isMobile()) {
          worksPanel.classList.remove('hide');
          isWorksPanelOpen = true;
        }
      }

      // Function to hide works panel
      function hideWorksPanel() {
        if (!isMobile()) {
          worksPanel.classList.add('hide');
          isWorksPanelOpen = false;
        }
      }

      // Initialize panel state based on current page
      if (isHomePage() && !isMobile()) {
        showWorksPanel();
      } else {
        hideWorksPanel();
      }

      // Add click handlers to works links
      worksLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          if (isMobile()) {
            // On mobile, show mobile works panel
            e.preventDefault();
            showMobileWorksPanel();
            return;
          }
          e.preventDefault();
          showWorksPanel();
        });
      });

      // Add click handlers to home links
      homeLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          if (isMobile()) {
            // On mobile, allow normal navigation
            return;
          }
          e.preventDefault();
          showWorksPanel();
          loadHomeContent();
        });
      });

      // Add click handlers to experience links
      const experienceLinks = document.querySelectorAll('a[href*="/experience"]');
      experienceLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          if (isMobile()) {
            // On mobile, allow normal navigation
            return;
          }
          e.preventDefault();
          showWorksPanel();
          loadExperienceContent();
        });
      });

      // Function to load home content
      function loadHomeContent() {
        const mainContent = document.getElementById('main-content');
        const mainContainer = document.getElementById('main-container');
        
        // Load the original home content
        fetch('/')
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Try multiple selectors to find the content
            const homeContent = doc.querySelector('#main-content') || 
                               doc.querySelector('main.content') ||
                               doc.querySelector('.main-content') || 
                               doc.querySelector('main') || 
                               doc.querySelector('.content');
                               
            if (homeContent) {
              // Preserve the container structure and classes
              mainContent.innerHTML = homeContent.innerHTML;
              
              // Ensure the main content has the proper classes
              mainContent.className = 'content content-emran';
              
              // Ensure the container has proper styling
              if (mainContainer) {
                mainContainer.className = 'container';
              }
              
              // Re-initialize any scripts that might be needed
              initializeHomeContent();
            } else {
              console.error('Could not find home content in fetched HTML');
              // Fallback: reload the page
              window.location.href = '/';
            }
          })
          .catch(error => {
            console.error('Error loading home content:', error);
            // Fallback: reload the page
            window.location.href = '/';
          });
      }

      // Function to initialize home content after loading
      function initializeHomeContent() {
        // Re-initialize any home-specific functionality if needed
        console.log('Home content loaded');
      }

      // Function to load experience content
      function loadExperienceContent() {
        const mainContent = document.getElementById('main-content');
        const mainContainer = document.getElementById('main-container');
        
        // Load the experience content
        fetch('/experience/')
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Try multiple selectors to find the content
            const experienceContent = doc.querySelector('#main-content') || 
                                     doc.querySelector('main.content') ||
                                     doc.querySelector('.main-content') || 
                                     doc.querySelector('main') || 
                                     doc.querySelector('.content');
                                     
            if (experienceContent) {
              // Preserve the container structure and classes
              mainContent.innerHTML = experienceContent.innerHTML;
              
              // Ensure the main content has the proper classes for experience
              mainContent.className = 'content content-experience';
              
              // Ensure the container has proper styling
              if (mainContainer) {
                mainContainer.className = 'container';
              }
              
            } else {
              console.error('Could not find experience content in fetched HTML');
              // Fallback: reload the page
              window.location.href = '/experience/';
            }
          })
          .catch(error => {
            console.error('Error loading experience content:', error);
            // Fallback: reload the page
            window.location.href = '/experience/';
          });
      }

      // Handle navigation to other pages
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (link && !isMobile()) {
          const href = link.getAttribute('href');
          // If navigating to a page that's not home or works, hide the panel
          // Exclude external links (starting with http) from this handler
          if (href && !href.startsWith('http') && !href.includes('/works') && href !== '/' && !href.includes('index')) {
            hideWorksPanel();
          }
        }
      });

      // Handle back button
      window.addEventListener('popstate', function(e) {
        if (isHomePage() && !isMobile()) {
          showWorksPanel();
        } else {
          hideWorksPanel();
        }
      });

      // Handle window resize
      window.addEventListener('resize', function() {
        if (isMobile()) {
          hideWorksPanel();
        } else if (isHomePage()) {
          showWorksPanel();
        }
      });

      // Mobile works panel functionality
      const mobileWorksPanel = document.getElementById('mobile-works-panel');
      const mobileWorksOverlay = document.getElementById('mobile-works-overlay');
      const mobileWorksFilterBtns = document.querySelectorAll('.mobile-works-filter-btn');
      const mobileWorksItems = document.querySelectorAll('.mobile-works-item');

      function showMobileWorksPanel() {
        if (isMobile()) {
          mobileWorksPanel.classList.add('show');
          mobileWorksOverlay.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      function hideMobileWorksPanel() {
        mobileWorksPanel.classList.remove('show');
        mobileWorksOverlay.classList.remove('show');
        document.body.style.overflow = '';
      }

      // Mobile works panel event listeners - overlay click to close
      if (mobileWorksOverlay) {
        mobileWorksOverlay.addEventListener('click', hideMobileWorksPanel);
      }

      // Mobile works filtering
      mobileWorksFilterBtns.forEach(button => {
        button.addEventListener('click', function() {
          const filter = this.getAttribute('data-filter');
          mobileWorksFilterBtns.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          mobileWorksItems.forEach(item => {
            if (filter === 'all' || item.getAttribute('data-type') === filter) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        });
      });

      // Works panel filtering functionality
      const filterButtons = document.querySelectorAll('.right-nav .works-nav-button');
      const items = document.querySelectorAll('.works-panel .pub-item');

      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          const filter = this.getAttribute('data-filter');
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          items.forEach(item => {
            if (filter === 'all' || item.getAttribute('data-type') === filter) {
              item.style.display = 'inline-block';
            } else {
              item.style.display = 'none';
            }
          });
        });
      });
    });

    // Scrollbar visibility control
    let scrollTimeout;
    document.addEventListener('scroll', function() {
      document.body.classList.add('scrolling');
      // Also add scrolling class to content elements
      const contentElements = document.querySelectorAll('.content');
      const worksPanelElements = document.querySelectorAll('.works-panel');
      
      contentElements.forEach(content => {
        content.classList.add('scrolling');
      });
      
      worksPanelElements.forEach(worksPanel => {
        worksPanel.classList.add('scrolling');
      });
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
        document.body.classList.remove('scrolling');
        contentElements.forEach(content => {
          content.classList.remove('scrolling');
        });
        worksPanelElements.forEach(worksPanel => {
          worksPanel.classList.remove('scrolling');
        });
      }, 1000);
    });

    // Enhanced smooth scrolling for all scrollable elements
    function smoothScrollTo(element, target, duration = 300) {
      const start = element.scrollTop;
      const change = target - start;
      const startTime = performance.now();

      function animateScroll(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 3) / 2;
        
        element.scrollTop = start + change * ease;
        
        if (progress < 1) {
          requestAnimationFrame(animateScroll);
        }
      }
      
      requestAnimationFrame(animateScroll);
    }

    // Apply smooth scrolling to all scrollable containers
    document.addEventListener('DOMContentLoaded', function() {
      const scrollableElements = document.querySelectorAll('.content, .container, .pubs-list');
      scrollableElements.forEach(element => {
        element.style.scrollBehavior = 'smooth';
      });
      
      // Add scroll event listeners to works panels
      const worksPanels = document.querySelectorAll('.works-panel');
      worksPanels.forEach(worksPanel => {
        let worksPanelScrollTimeout;
        worksPanel.addEventListener('scroll', function() {
          worksPanel.classList.add('scrolling');
          clearTimeout(worksPanelScrollTimeout);
          worksPanelScrollTimeout = setTimeout(function() {
            worksPanel.classList.remove('scrolling');
          }, 1000);
        });
      });
      
      // Sort masonry items chronologically
      function sortMasonryChronologically() {
        const pubsList = document.querySelector('.pubs-list');
        if (!pubsList) return;
        
        const items = Array.from(pubsList.querySelectorAll('.pub-item'));
        
        // Sort items by date (newest first)
        items.sort((a, b) => {
          const dateA = a.getAttribute('data-date') || '0000-00-00';
          const dateB = b.getAttribute('data-date') || '0000-00-00';
          return dateB.localeCompare(dateA); // Newest first
        });
        
        // Re-append sorted items
        items.forEach(item => pubsList.appendChild(item));
      }
      
      // Sort items after a short delay to ensure all content is loaded
      setTimeout(sortMasonryChronologically, 100);
    });
  </script>
</body>
</html>